services:
  php:
    # Use PHP 7.1 with Apache
    image: tugboatqa/php:7.1-apache
    default: true
    # Wait until the mysql service is done building
    depends: mysql
    commands:

      # Commands that set up the basic preview infrastructure
      init: | 
        set -x
        # Install prerequisite packages
        apt-get update
        apt-get install -y mysql-client nano

        # Install drush-launcher
        wget -O /usr/local/bin/drush https://github.com/drush-ops/drush-launcher/releases/download/0.6.0/drush.phar
        chmod +x /usr/local/bin/drush

        # Link the document root to the expected path. Tugboat uses /docroot
        # by default. So, if Drupal is located at any other path in your git
        # repository, change that here. This example links /web to the docroot
        ln -snf "${TUGBOAT_ROOT}/docroot" "${DOCROOT}"

        #docker-php-ext-install opcache
        #a2enmod headers rewrite      

        #chgrp -R www-data "${DOCROOT}/sites/default/files"
        #find "${DOCROOT}/sites/default/files" -type d -exec chmod 2775 {} \;
        #find "${DOCROOT}/sites/default/files" -type f -exec chmod 0664 {} \;

      update:
        set -x
        cp -r "${TUGBOAT_ROOT}/magazineplus/d8/full_installation/site/." "${DOCROOT}"

  # What to call the service hosting MySQL. This name also acts as the
  # hostname to access the service by from the php service.
  mysql:

    # Use the latest available 5.x version of MySQL
    image: tugboatqa/mysql:5
    checkout: true
    
    commands:
      update:
        #set -x
        #cat "${TUGBOAT_ROOT}/magazineplus/d8/full_installation/database/db_instance.sql" | mysql tugboat

